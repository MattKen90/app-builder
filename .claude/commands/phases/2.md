---
description: Phase 2 - Technical Foundation. Design architecture and build roadmap from the vision.
---

# Phase 2: Technical Foundation

**Mission**: Transform VISION.md into buildable architecture and sequenced roadmap. Uses hybrid approach: interactive validation in main context, autonomous design via subagent.

---

## Mode Detection

Read `.state.json` to determine paths:

| Context | Greenfield | Enhancer |
|---------|------------|----------|
| Input | `VISION.md` | `.enhancer/VISION.md` + `DISCOVERY.md` |
| Output | `ARCHITECTURE.md`, `ROADMAP.md` | `.enhancer/ARCHITECTURE.md`, `.enhancer/ROADMAP.md` |

---

## Pre-Flight Check

```
1. Read `.state.json`
2. Verify VISION.md exists at correct path
3. If missing → "Phase 1 not complete. Run /phases/1 first."
4. If exists → Proceed
```

---

## Process Overview

```
┌─────────────────────────────────────────────────────────────┐
│ MAIN CONTEXT (Interactive)                                  │
├─────────────────────────────────────────────────────────────┤
│ Step 1: Quick Constraint Check                              │
│   - Any existing infrastructure to integrate with?          │
│   - Team skill constraints? (Prefer/avoid languages?)       │
│   - Deployment constraints? (Cloud, on-prem?)               │
│   - Budget constraints?                                     │
│   → Write constraints to {output_dir}/CONSTRAINTS.md        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ SUBAGENT (Autonomous)                                       │
├─────────────────────────────────────────────────────────────┤
│ Step 2: RESEARCH - Technology options (use WebSearch)       │
│ Step 3: ARCHITECT - Design system, map features             │
│ Step 4: ROADMAP - Sequence build, define phases             │
│   → ALL work persisted to files before returning            │
│   → Returns only: summary + key decisions                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ MAIN CONTEXT (Interactive)                                  │
├─────────────────────────────────────────────────────────────┤
│ Step 5: Present tech stack and roadmap summary              │
│ Step 6: Get approval or iterate                             │
│ Step 7: Update state, handoff to Phase 3                    │
└─────────────────────────────────────────────────────────────┘
```

---

## Step 1: Constraint Check (Main Context)

Quick validation before spawning subagent:

1. "Any existing infrastructure this must integrate with?"
2. "Team skill preferences? Languages/frameworks to prefer or avoid?"
3. "Deployment constraints? Specific cloud, on-prem requirements?"
4. "Budget constraints affecting hosting/services?"

Write responses to `{output_dir}/CONSTRAINTS.md`.

If user says "none" or "no constraints", proceed immediately.

---

## Step 2-4: RESEARCH, ARCHITECT, ROADMAP (Subagent)

**Use the Task tool to spawn tech-architect for autonomous work:**

```
Task tool parameters:
  subagent_type: "general-purpose"
  description: "Architecture design and roadmap"
  prompt: |
    You are the tech-architect agent. Read your full instructions from:
    .claude/agents/tech-architect.md

    CONTEXT:
    - Mode: {greenfield|enhancer}
    - Vision: {path to VISION.md}
    - Constraints: {path to CONSTRAINTS.md}
    - Discovery (if enhancer): .enhancer/DISCOVERY.md

    YOUR MISSION (autonomous, no user interaction):
    1. RESEARCH: Analyze requirements, research tech options (use WebSearch)
    2. ARCHITECT: Design system, map features to components, define data model
    3. ROADMAP: Sequence features into phases, Phase 1 MUST include payments

    CRITICAL REQUIREMENTS:
    1. Write tech research to {output_dir}/TECH_RESEARCH.md
    2. Write architecture to {output_dir}/ARCHITECTURE.md
    3. Write roadmap to {output_dir}/ROADMAP.md
    4. Do NOT return full documents - they're in the files
    5. Return ONLY:
       - Confirmation files written
       - Tech stack summary (1 line per layer)
       - Phase count and feature distribution
       - Key architectural decision (1-2 sentences)

    OUTPUT PATHS:
    - Greenfield: ARCHITECTURE.md, ROADMAP.md, TECH_RESEARCH.md at root
    - Enhancer: .enhancer/ARCHITECTURE.md, .enhancer/ROADMAP.md, .enhancer/TECH_RESEARCH.md

    KEY PRINCIPLES:
    - MRR is King: Payments (F-PAY) goes in Phase 1
    - Extension by addition: Features don't modify each other
    - Ruthless minimalism: Simple primitives, emergent complexity
```

---

## Step 5-6: Review & Approve (Main Context)

After subagent returns:

1. Read ARCHITECTURE.md and ROADMAP.md
2. Present summary to user:
   - Tech stack table
   - Phase breakdown with feature counts
   - Critical path items
   - Any risks flagged

3. Ask: "Approve this architecture and roadmap? Or would you like to adjust?"

4. If adjustments needed:
   - Make edits directly to files
   - Re-confirm with user

---

## Step 7: Finalize

Once approved:

1. Update `.state.json`:
   - Set `app.phase` to 3
   - Set `ddd.last_action` to "Architecture approved, ready for build"

2. Display handoff

---

## Handoff

```
✅ Phase 2 Complete: Technical Foundation

ARCHITECTURE.md: {path based on mode}
ROADMAP.md: {path based on mode}
TECH_RESEARCH.md: {path based on mode}

Technical foundation is set:
- Tech stack chosen
- Architecture designed
- Features mapped to components
- Build sequence defined
- Payments in Phase 1

Ready for Phase 3: Build

Run: /phases/3
```

---

## File Outputs

| File | Purpose | Written By |
|------|---------|------------|
| CONSTRAINTS.md | User constraints | Main context |
| TECH_RESEARCH.md | Technology research | Subagent |
| ARCHITECTURE.md | System design | Subagent |
| ROADMAP.md | Build sequence | Subagent |
